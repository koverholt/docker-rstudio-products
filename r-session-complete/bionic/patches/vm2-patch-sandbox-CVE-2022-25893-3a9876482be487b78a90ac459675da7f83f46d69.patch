From 3a9876482be487b78a90ac459675da7f83f46d69 Mon Sep 17 00:00:00 2001
From: XmiliaH <xmilia.hermit@gmail.com>
Date: Tue, 5 Jul 2022 14:26:06 +0200
Subject: [PATCH] Fix security issue

---
 lib/setup-sandbox.js | 9 ++++++---
 1 file changed, 6 insertions(+), 3 deletions(-)

diff --git a/lib/setup-sandbox.js b/lib/setup-sandbox.js
index 2149cc3..57b789a 100644
--- a/lib/setup-sandbox.js
+++ b/lib/setup-sandbox.js
@@ -51,7 +51,10 @@ const {
 	AsyncGeneratorFunction
 } = data;
 
-const localWeakMapGet = LocalWeakMap.prototype.get;
+const {
+	get: localWeakMapGet,
+	set: localWeakMapSet
+ } = LocalWeakMap.prototype;
 
 function localUnexpected() {
 	return new VMError('Should not happen');
@@ -282,8 +285,8 @@ if (typeof OriginalCallSite === 'function') {
 				}
 				return value(error, sst);
 			};
-			wrappedPrepareStackTrace.set(value, newWrapped);
-			wrappedPrepareStackTrace.set(newWrapped, newWrapped);
+			localReflectApply(localWeakMapSet, wrappedPrepareStackTrace, [value, newWrapped]);
+			localReflectApply(localWeakMapSet, wrappedPrepareStackTrace, [newWrapped, newWrapped]);
 			currentPrepareStackTrace = newWrapped;
 		}
 	})) throw localUnexpected();
